name: Deploy AWS Static Site

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: AWS region
        required: true
        default: us-east-1
      s3_bucket:
        description: Target S3 bucket (from Terraform output)
        required: false
      cloudfront_distribution_id:
        description: CloudFront distribution ID (from Terraform output)
        required: false
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      NUXT_GENERATE_DIR: .output/public
      S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      S3_BUCKET_INPUT: ${{ github.event.inputs.s3_bucket }}
      DISTRIBUTION_ID_INPUT: ${{ github.event.inputs.cloudfront_distribution_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Typecheck
        run: bunx tsc --noEmit
        continue-on-error: true

      - name: Build static site
        run: bun run generate

      - name: Ensure output dir exists
        run: |
          if [ ! -d "$NUXT_GENERATE_DIR" ]; then
            echo "Expected generate output at $NUXT_GENERATE_DIR, listing tree for debugging:" && ls -la .output || true
            echo "::error::Nuxt generate output directory not found" && exit 1
          fi
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
        if: ${{ env.AWS_ROLE_TO_ASSUME != '' }}

      - name: Configure AWS credentials (access keys)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
        if: ${{ env.AWS_ROLE_TO_ASSUME == '' }}

      - name: Resolve target resources
        run: |
          S3="${S3_BUCKET_INPUT:-$S3_BUCKET}"
          CF="${DISTRIBUTION_ID_INPUT:-$DISTRIBUTION_ID}"
          if [ -z "$S3" ]; then
            echo "::error::S3 bucket not provided. Set workflow input 's3_bucket' or secret 'AWS_S3_BUCKET'."
            exit 1
          fi
          if [ -z "$CF" ]; then
            echo "::error::CloudFront distribution ID not provided. Set workflow input 'cloudfront_distribution_id' or secret 'CLOUDFRONT_DISTRIBUTION_ID'."
            exit 1
          fi
          echo "S3_BUCKET_RESOLVED=$S3" >> $GITHUB_ENV
          echo "CF_DIST_ID_RESOLVED=$CF" >> $GITHUB_ENV

      - name: Sync assets to S3
        run: |
          aws s3 sync "$NUXT_GENERATE_DIR" "s3://${S3_BUCKET_RESOLVED}" --delete

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation --distribution-id "${CF_DIST_ID_RESOLVED}" --paths '/*'
