name: Deploy AWS Static Site

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: AWS region
        required: true
        default: us-east-1
      project_name:
        description: Project name
        required: true
        default: gym-app
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ github.event.inputs.aws_region || 'us-east-1' }}
      PROJECT_NAME: ${{ github.event.inputs.project_name || 'gym-app' }}
      NUXT_GENERATE_DIR: .output/public

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.4'

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Typecheck
        run: bunx tsc --noEmit
        continue-on-error: true

      - name: Build static site
        run: bun run generate

      - name: Ensure output dir exists
        run: |
          if [ ! -d "$NUXT_GENERATE_DIR" ]; then
            echo "Expected generate output at $NUXT_GENERATE_DIR, listing tree for debugging:" && ls -la .output || true
            echo "::error::Nuxt generate output directory not found" && exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
        if: ${{ secrets.AWS_ROLE_TO_ASSUME != '' }}

      - name: Configure AWS credentials (access keys)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
        if: ${{ secrets.AWS_ROLE_TO_ASSUME == '' }}

      - name: Terraform Init
        working-directory: infra
        run: terraform init

      - name: Terraform Validate
        working-directory: infra
        run: terraform validate

      - name: Terraform Apply
        working-directory: infra
        run: terraform apply -auto-approve -var "project_name=${PROJECT_NAME}" -var "aws_region=${AWS_REGION}" -var "enable_static_hosting=true"

      - name: Read Terraform Outputs
        id: tf-outputs
        working-directory: infra
        run: |
          echo "bucket_name=$(terraform output -raw static_s3_bucket_name)" >> $GITHUB_OUTPUT
          echo "distribution_id=$(terraform output -raw cloudfront_distribution_id)" >> $GITHUB_OUTPUT

      - name: Sync assets to S3
        run: |
          aws s3 sync "$NUXT_GENERATE_DIR" "s3://${{ steps.tf-outputs.outputs.bucket_name }}" --delete

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation --distribution-id "${{ steps.tf-outputs.outputs.distribution_id }}" --paths '/*'

