name: Deploy AWS Static Site

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: AWS region
        required: true
        default: us-east-1
      s3_bucket:
        description: Target S3 bucket (from Terraform output)
        required: false
      cloudfront_distribution_id:
        description: CloudFront distribution ID (from Terraform output)
        required: false
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      NUXT_GENERATE_DIR: .output/public
      S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      S3_BUCKET_INPUT: ${{ github.event.inputs.s3_bucket }}
      NUXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NUXT_PUBLIC_FIREBASE_API_KEY }}
      NUXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NUXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
      NUXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NUXT_PUBLIC_FIREBASE_PROJECT_ID }}
      NUXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NUXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
      NUXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NUXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
      NUXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NUXT_PUBLIC_FIREBASE_APP_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Typecheck
        run: bunx tsc --noEmit
        continue-on-error: true

      - name: Build static site and server
        run: |
          NITRO_PRESET=aws-lambda bun run build

      - name: Ensure output dirs exist
        run: |
          if [ ! -d "$NUXT_GENERATE_DIR" ]; then
            echo "::error::Nuxt public output directory not found" && exit 1
          fi
          if [ ! -f ".output/server/index.mjs" ]; then
            echo "::error::Nitro server output not found" && exit 1
          fi

      - name: Zip Lambda function
        run: |
          cd .output/server
          zip -r ../../lambda.zip .
          cd ../..
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
        if: ${{ env.AWS_ROLE_TO_ASSUME != '' }}

      - name: Configure AWS credentials (access keys)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
        if: ${{ env.AWS_ROLE_TO_ASSUME == '' }}

      - name: Resolve target resources
        run: |
          S3="$S3_BUCKET_INPUT"
          CF="$DISTRIBUTION_ID"
          LAMBDA="${{ secrets.AWS_LAMBDA_FUNCTION_NAME }}"
          if [ -z "$S3" ]; then S3="$S3_BUCKET"; fi
          if [ -z "$CF" ]; then CF="$DISTRIBUTION_ID"; fi
          if [ -z "$LAMBDA" ]; then LAMBDA="gym-app-api"; fi
          
          echo "S3_BUCKET_RESOLVED=$S3" >> $GITHUB_ENV
          echo "CF_DIST_ID_RESOLVED=$CF" >> $GITHUB_ENV
          echo "LAMBDA_NAME_RESOLVED=$LAMBDA" >> $GITHUB_ENV

      - name: Sync assets to S3
        run: |
          aws s3 sync "$NUXT_GENERATE_DIR" "s3://${S3_BUCKET_RESOLVED}" --delete

      - name: Deploy to Lambda
        run: |
          aws lambda update-function-code --function-name "${LAMBDA_NAME_RESOLVED}" --zip-file fileb://lambda.zip
          
          # Wait for the code update to complete before updating configuration
          aws lambda wait function-updated --function-name "${LAMBDA_NAME_RESOLVED}"
          
          # Update environment variables
          aws lambda update-function-configuration --function-name "${LAMBDA_NAME_RESOLVED}" \
            --environment "Variables={FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }},FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }},FIREBASE_PRIVATE_KEY=${{ secrets.FIREBASE_PRIVATE_KEY }},NODE_ENV=production}"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation --distribution-id "${CF_DIST_ID_RESOLVED}" --paths '/*'
