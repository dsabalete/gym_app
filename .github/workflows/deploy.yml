name: Deploy to AWS Lambda

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: us-east-1
  SLS_INTERACTIVE_SETUP_ENABLE: 1

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: '1.3.4'
    
    - name: Install dependencies
      run: bun install --frozen-lockfile
    
    - name: Run tests
      run: bun test
      continue-on-error: true
    
    - name: Build application
      run: bun run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: '1.3.4'
    
    - name: Install dependencies
      run: bun install --frozen-lockfile
    
    - name: Build application
      run: bun run build
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Deploy to AWS Lambda
      run: |
        bunx serverless@^3.38.0 deploy \
          --stage prod \
          --region ${{ env.AWS_REGION }} \
          --verbose
      env:
        RDS_CLUSTER_ARN: ${{ secrets.RDS_CLUSTER_ARN }}
        RDS_SECRET_ARN: ${{ secrets.RDS_SECRET_ARN }}
        RDS_DATABASE_NAME: ${{ secrets.RDS_DATABASE_NAME }}
    
    - name: Initialize Database
      run: |
        # Wait a moment for the deployment to stabilize
        sleep 10
        
        # Get the API endpoint from the deployment
        API_ENDPOINT=$(bunx serverless@^3.38.0 info --stage prod --verbose | grep -A 5 "endpoints:" | grep -o "https://[^[:space:]]*" | head -1)
        
        # Initialize the database
        curl -X POST "${API_ENDPOINT}/api/database/init" \
          -H "Content-Type: application/json" \
          || echo "Database initialization may have already been completed"
    
    - name: Output deployment info
      run: |
        echo "Deployment completed successfully!"
        echo "API Endpoint: $(bunx serverless@^3.38.0 info --stage prod | grep -A 5 'endpoints:' | grep -o 'https://[^[:space:]]*' | head -1)"
        echo "Functions:"
        bunx serverless@^3.38.0 info --stage prod | grep -A 10 "functions:"
